name: Build SimplyToast Packages

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    name: Build All Packages
    runs-on: ubuntu-latest

    steps:
      # --- CHECKOUT REPO ---
      - name: Checkout repo
        uses: actions/checkout@v3

      # --- PREPARE PYTHON FOR DEB + APPIMAGE ---
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Python build tools
        run: |
          python -m pip install --upgrade pip wheel build

      # --- BUILD SOURCE TARBALL (.tar.gz) ---
      - name: Build source tarball
        run: |
          mkdir -p dist
          tar czf dist/SimplyToast-${GITHUB_REF_NAME#v}.tar.gz \
              src assets data LICENSE README.md

      # --- BUILD .deb PACKAGE ---
      - name: Build Debian package
        run: |
          mkdir -p deb_build/usr/bin
          mkdir -p deb_build/usr/share/simplytoast
          mkdir -p deb_build/usr/share/applications
          mkdir -p deb_build/usr/share/icons/hicolor/512x512/apps

          install -Dm755 src/main.py deb_build/usr/bin/simplytoast
          cp -r assets data deb_build/usr/share/simplytoast/
          cp data/com.toast1599.SimplyToast.desktop deb_build/usr/share/applications/
          cp data/simplytoast.png deb_build/usr/share/icons/hicolor/512x512/apps/

          mkdir -p deb_build/DEBIAN
          cat <<EOF > deb_build/DEBIAN/control
Package: simplytoast
Version: ${GITHUB_REF_NAME#v}
Architecture: all
Maintainer: toast1599
Description: Startup application manager
EOF

          dpkg-deb --build deb_build dist/simplytoast_${GITHUB_REF_NAME#v}.deb

      # --- BUILD APPIMAGE ---
      - name: Download linuxdeploy + AppImage plugin
        run: |
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

      - name: Build AppImage
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/simplytoast
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/512x512/apps

          install -Dm755 src/main.py AppDir/usr/bin/simplytoast
          cp -r assets data AppDir/usr/share/simplytoast/
          cp data/com.toast1599.SimplyToast.desktop AppDir/usr/share/applications/
          cp data/simplytoast.png AppDir/usr/share/icons/hicolor/512x512/apps/

          ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --output appimage

          mv SimplyToast*.AppImage dist/SimplyToast-${GITHUB_REF_NAME#v}.AppImage

      # --- BUILD ARCH PKG (.pkg.tar.zst) ---
      - name: Install Arch container + build tools
        uses: archlinux/archlinux-container-action@v2

      - name: Build Arch package
        run: |
          mkdir archpkg
          cp PKGBUILD archpkg/
          cp dist/SimplyToast-${GITHUB_REF_NAME#v}.tar.gz archpkg/

          cd archpkg
          makepkg -fs --noconfirm

          mv simplytoast-*.pkg.tar.zst ../dist/

      # --- CREATE RELEASE & UPLOAD FILES ---
      - name: Upload release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            dist/*.tar.gz
            dist/*.deb
            dist/*.AppImage
            dist/*.pkg.tar.zst
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
