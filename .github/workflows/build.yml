name: Build SimplyToast Packages

on:
  push:
    tags:
      - "v*"

jobs:

  # ===========================
  # UBUNTU JOB (DEB + APPIMAGE + TARBALL)
  # ===========================
  build-ubuntu:
    name: Build DEB / AppImage / Tarball
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ github.ref_name }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Python tools
        run: |
          python -m pip install --upgrade pip wheel build

      - name: Build source tarball
        run: |
          mkdir -p dist
          tar czf dist/SimplyToast-${VERSION}.tar.gz src assets data LICENSE README.md

      - name: Build DEB
        run: |
          mkdir -p deb_build/usr/bin
          mkdir -p deb_build/usr/share/simplytoast
          mkdir -p deb_build/usr/share/applications
          mkdir -p deb_build/usr/share/icons/hicolor/512x512/apps

          install -Dm755 src/main.py deb_build/usr/bin/simplytoast
          cp -r assets data deb_build/usr/share/simplytoast/
          cp data/com.toast1599.SimplyToast.desktop deb_build/usr/share/applications/
          cp data/simplytoast.png deb_build/usr/share/icons/hicolor/512x512/apps/

          mkdir -p deb_build/DEBIAN

          echo "Package: simplytoast" > deb_build/DEBIAN/control
          echo "Version: ${VERSION}" >> deb_build/DEBIAN/control
          echo "Architecture: all" >> deb_build/DEBIAN/control
          echo "Maintainer: toast1599" >> deb_build/DEBIAN/control
          echo "Description: Startup application manager" >> deb_build/DEBIAN/control

          dpkg-deb --build deb_build dist/simplytoast_${VERSION}.deb

      - name: Download linuxdeploy
        run: |
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

      - name: Build AppImage
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/simplytoast
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/512x512/apps

          install -Dm755 src/main.py AppDir/usr/bin/simplytoast
          cp -r assets data AppDir/usr/share/simplytoast/
          cp data/com.toast1599.SimplyToast.desktop AppDir/usr/share/applications/
          cp data/simplytoast.png AppDir/usr/share/icons/hicolor/512x512/apps/

          ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage

          mv SimplyToast*.AppImage dist/SimplyToast-${VERSION}.AppImage

      - name: Upload Ubuntu artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-artifacts
          path: dist/

  # ===========================
  # ARCH PACKAGE JOB
  # ===========================
  build-arch:
    name: Build Arch Package
    runs-on: ubuntu-latest
    needs: build-ubuntu

    container:
      image: archlinux:latest

    steps:
      - name: Install pacman deps
        run: |
          pacman -Sy --noconfirm base-devel git tar xz

      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Build Arch package
        run: |
          mkdir -p dist
          makepkg -fs --noconfirm
          mv simplytoast-*.pkg.tar.zst dist/

      - name: Upload Arch artifacts
        uses: actions/upload-artifact@v4
        with:
          name: arch-artifacts
          path: dist/

  # ===========================
  # RELEASE JOB
  # ===========================
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-ubuntu, build-arch]

    steps:
      - name: Download Ubuntu artifacts
        uses: actions/download-artifact@v4
        with:
          name: ubuntu-artifacts
          path: dist

      - name: Download Arch artifacts
        uses: actions/download-artifact@v4
        with:
          name: arch-artifacts
          path: dist

      - name: Publish release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: dist/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
